---
layout: default
title: "Optimizing SQL Queries"
date: 2019-08-11
categories: blog
---
<div>
  <h2>Discovering the Issue</h2>

  <p>Before the first release of the tool, I wanted to provide some built-in queries accessible through the client UI out-of-the-box. While building those queries, I ran into an issue where some queries were exceeding the query time limits (even for administrator privileges!). Some queries were taking more than 30 seconds to return.</p>
  
  <p>
  {% highlight ruby %}
    SELECT sample_id,md5,sha1,sha256,total,positives,list,filetype,submitted,user_id,username,downloads FROM
(SELECT filtered.sample_id,COUNT(filtered.download_id) AS downloads FROM
(SELECT DISTINCT ON (sample.id, downloadhistory) sample.id AS sample_id, downloadhistory.id AS download_id FROM
sample JOIN virustotal ON sample.id = virustotal.sample_id JOIN yaramatches ON sample.id = yaramatches.sample_id JOIN yararules ON yaramatches.rule_id = yararules.id LEFT JOIN downloadhistory ON sample.id = downloadhistory.sample_id
WHERE (virustotal.result ILIKE '%' || @parameter0|| '%' or yaramatches.name ILIKE '%' || @parameter1|| '%')) AS filtered
GROUP BY filtered.sample_id
) AS subquery JOIN sample ON subquery.sample_id = sample.id JOIN users ON sample.user_id = users.id
ORDER BY downloads DESC
LIMIT 50;
  {% endhighlight %}
  </p>
  
  <p>
Limit  (cost=1172472.11..1172472.23 rows=50 width=259) (actual time=11924.586..11924.653 rows=50 loops=1)
->  Sort  (cost=1172472.11..1172472.61 rows=200 width=259) (actual time=11924.585..11924.589 rows=50 loops=1)
    Sort Key: (count(downloadhistory.id)) DESC
    Sort Method: top-N heapsort  Memory: 38kB
    ->  Hash Join  (cost=1165965.64..1172465.46 rows=200 width=259) (actual time=11588.639..11919.765 rows=8316 loops=1)
          Hash Cond: (sample.user_id = users.id)
          ->  Nested Loop  (cost=1165952.94..1172452.21 rows=200 width=177) (actual time=11588.618..11915.692 rows=8316 loops=1)
                ->  GroupAggregate  (cost=1165952.52..1170802.21 rows=200 width=12) (actual time=11587.625..11601.856 rows=8316 loops=1)
                      Group Key: virustotal.sample_id
                      ->  Unique  (cost=1165952.52..1167568.42 rows=215453 width=52) (actual time=11587.619..11597.707 rows=8316 loops=1)
                            ->  Sort  (cost=1165952.52..1166491.15 rows=215453 width=52) (actual time=11587.616..11592.034 rows=41206 loops=1)
                                  Sort Key: virustotal.sample_id, downloadhistory.*
                                  Sort Method: quicksort  Memory: 3297kB
                                  ->  Gather  (cost=1117272.42..1139499.10 rows=215453 width=52) (actual time=11536.545..11575.371 rows=41206 loops=1)
                                        Workers Planned: 1
                                        Workers Launched: 1
                                        ->  Merge Left Join  (cost=1116272.42..1116953.80 rows=126737 width=52) (actual time=11528.090..11538.640 rows=20603 loops=2)
                                              Merge Cond: (virustotal.sample_id = downloadhistory.sample_id)
                                              ->  Sort  (cost=1116154.20..1116471.04 rows=126737 width=4) (actual time=11527.998..11532.344 rows=20603 loops=2)
                                                    Sort Key: virustotal.sample_id
                                                    Sort Method: quicksort  Memory: 1630kB
                                                    ->  Nested Loop  (cost=19.89..1105412.30 rows=126737 width=4) (actual time=0.842..11518.095 rows=20603 loops=2)
                                                          ->  Hash Join  (cost=19.45..2074.00 rows=48022 width=24) (actual time=0.077..169.150 rows=41566 loops=2)
                                                                Hash Cond: (yaramatches.rule_id = yararules.id)
                                                                ->  Parallel Seq Scan on yaramatches  (cost=0.00..1927.22 rows=48022 width=28) (actual time=0.005..131.264 rows=41566 loops=2)
                                                                ->  Hash  (cost=14.20..14.20 rows=420 width=4) (actual time=0.022..0.022 rows=6 loops=2)
                                                                      Buckets: 1024  Batches: 1  Memory Usage: 9kB
                                                                      ->  Seq Scan on yararules  (cost=0.00..14.20 rows=420 width=4) (actual time=0.017..0.018 rows=6 loops=2)
                                                          ->  Index Scan using sampleid_idx on virustotal  (cost=0.44..22.95 rows=3 width=13) (actual time=0.261..0.272 rows=0 loops=83131)
                                                                Index Cond: (sample_id = yaramatches.sample_id)
                                                                Filter: (((result)::text ~~* '%crypt%'::text) OR (yaramatches.name ~~* '%crypt%'::text))
                                                                Rows Removed by Filter: 54
                                              ->  Sort  (cost=118.22..122.47 rows=1700 width=52) (actual time=0.080..0.083 rows=11 loops=2)
                                                    Sort Key: downloadhistory.sample_id
                                                    Sort Method: quicksort  Memory: 26kB
                                                    ->  Seq Scan on downloadhistory  (cost=0.00..27.00 rows=1700 width=52) (actual time=0.063..0.066 rows=11 loops=2)
                ->  Index Scan using sample_pkey on sample  (cost=0.42..8.24 rows=1 width=169) (actual time=0.037..0.037 rows=1 loops=8316)
                      Index Cond: (id = virustotal.sample_id)
          ->  Hash  (cost=11.20..11.20 rows=120 width=86) (actual time=0.013..0.013 rows=3 loops=1)
                Buckets: 1024  Batches: 1  Memory Usage: 9kB
                ->  Seq Scan on users  (cost=0.00..11.20 rows=120 width=86) (actual time=0.009..0.010 rows=3 loops=1)
Planning time: 0.977 ms
Execution time: 11925.217 ms
  </p>
</div>
